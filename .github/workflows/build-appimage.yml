name: Build AppImage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-appimage:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pillow pyinstaller
    
    - name: Create AppDir structure
      run: |
        mkdir -p AppDir/usr/{bin,share/{applications,icons/hicolor/128x128/apps}}
    
    - name: Create desktop file
      run: |
        cat > AppDir/usr/share/applications/image-resizer.desktop << 'EOF'
        [Desktop Entry]
        Name=Image Resizer
        Comment=Batch resize images with ease
        Exec=image-resizer
        Icon=image-resizer
        Terminal=false
        Type=Application
        Categories=Graphics;Utility;
        EOF
    
    - name: Convert and copy icon
      run: |
        # Install ImageMagick if not already installed
        sudo apt-get install -y imagemagick
        # Convert ICO to PNG and copy to the right location
        convert image-resizer/resize_image_app_icon.ico AppDir/usr/share/icons/hicolor/128x128/apps/image-resizer.png    
    
    - name: PyInstaller build
      run: |
        pyinstaller --onefile --name image-resizer image_resizer.py
        cp dist/image-resizer AppDir/usr/bin/
        chmod +x AppDir/usr/bin/image-resizer
        
        # Create AppRun file
        cat > AppDir/AppRun << 'EOF'
        #!/bin/bash
        SELF=$(readlink -f "$0")
        HERE=${SELF%/*}
        export PATH="${HERE}/usr/bin:${PATH}"
        export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
        "${HERE}/usr/bin/image-resizer" "$@"
        EOF
        chmod +x AppDir/AppRun
        
        # Create symlinks
        ln -s usr/share/applications/image-resizer.desktop AppDir/image-resizer.desktop
        ln -s usr/share/icons/hicolor/128x128/apps/image-resizer.png AppDir/image-resizer.png
    
    - name: Download AppImageTool
      run: |
        wget -O appimagetool-x86_64.AppImage https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool-x86_64.AppImage
    
    - name: Build AppImage
      run: |
        ./appimagetool-x86_64.AppImage AppDir
    
    - name: Upload AppImage
      uses: actions/upload-artifact@v3
      with:
        name: image-resizer-appimage
        path: Image_Resizer*.AppImage
